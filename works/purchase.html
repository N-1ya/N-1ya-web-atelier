<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>購入ページ - 市屋 凪</title>
  <style>
    @font-face {
      font-family: 'KokuMincho';
      src: url('fonts/KokuMincho-Regular.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }

    body, html {
      margin: 0;
      padding: 0;
      background: black;
      height: 100%;
      font-family: 'KokuMincho', serif;
      color: #fff;
      text-align: center;
    }

    #menuButton {
      position: fixed;
      top: 1rem;
      right: 1rem;
      width: 32px;
      height: 24px;
      cursor: pointer;
      z-index: 10002;
      display: block;
    }
    #menuButton div {
      background-color: white;
      height: 4px;
      margin: 4px 0;
      border-radius: 2px;
      transition: all 0.3s ease;
    }
    #menuButton.open div:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }
    #menuButton.open div:nth-child(2) {
      opacity: 0;
    }
    #menuButton.open div:nth-child(3) {
      transform: rotate(-45deg) translate(6px, -6px);
    }

    #sidebar {
      position: fixed;
      top: 0; right: 0;
      width: 250px;
      height: 100vh;
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 2rem 1rem;
      box-sizing: border-box;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 10001;
      text-align: left;
    }
    #sidebar.open {
      transform: translateX(0);
    }
    #sidebar a {
      display: block;
      color: white;
      text-decoration: none;
      margin: 1rem 0;
      font-size: 1.2rem;
    }

    .form-container {
      background: #333;
      padding: 2rem;
      margin: 6rem auto 3rem;
      max-width: 600px;
      border-radius: 10px;
      text-align: left;
    }
    .form-container h2 {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    .form-group.order-number {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 1.5rem;
    }
    .form-row {
      display: flex;
      gap: 1rem;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      cursor: pointer;
    }
    input[type="text"],
    input[type="email"],
    input[type="tel"],
    select,
    textarea,
    button {
      width: 100%;
      padding: 0.5rem;
      font-family: 'KokuMincho', serif;
      font-size: 1rem;
      border-radius: 5px;
      border: none;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
    }
    .small-note {
      font-size: 0.8rem;
      color: #ccc;
    }
    .small-button {
      width: auto;
      padding: 0.3rem 1rem;
      font-size: 0.9rem;
      margin-top: 1.7rem;
    }
    .confirm-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      padding: 2rem;
      border-radius: 10px;
      z-index: 10010;
      max-width: 90vw;
      width: 400px;
      display: none;
      color: #fff;
    }
    .confirm-dialog h3 {
      margin-top: 0;
      font-size: 1.2rem;
    }
    .dialog-buttons {
      margin-top: 1rem;
      text-align: center;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
    .dialog-buttons button {
      padding: 0.5rem 1rem;
      border-radius: 5px;
      border: none;
      font-family: 'KokuMincho', serif;
      font-size: 1rem;
      cursor: pointer;
    }
    .dialog-buttons button:hover {
      opacity: 0.8;
    }
    .product-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .product-info img {
      width: 50px;
      height: auto;
    }
    .payment-method {
      text-align: left;
    }
    .payment-method input[type="radio"] {
      margin-right: 0.5rem;
      vertical-align: middle;
      cursor: pointer;
    }
    .payment-method label {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
      cursor: pointer;
      user-select: none;
    }
    .payment-fields {
      margin-top: 1rem;
      display: none;
    }
    .price-info {
      text-align: right;
      margin-top: 1rem;
    }
    /* カート内商品リスト表示 */
    #productList {
      background: #444;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 8px;
      max-height: 250px;
      overflow-y: auto;
    }
    .cart-item {
      display: flex;
      gap: 1rem;
      margin-bottom: 0.8rem;
      align-items: center;
      border-bottom: 1px solid #666;
      padding-bottom: 0.5rem;
    }
    .cart-item img {
      width: 60px;
      height: auto;
      border-radius: 5px;
    }
    .cart-item div p {
      margin: 2px 0;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div id="menuButton" aria-label="メニュー" role="button" tabindex="0">
    <div></div>
    <div></div>
    <div></div>
  </div>
  <div id="sidebar">
    <a href="/">ホーム</a>
    <a href="/profile/">プロフィール</a>
    <a href="/works/">ギャラリー</a>
    <a href="/contact/">お問い合わせ</a>
  </div>

  <div class="form-container">
    <h2>購入フォーム</h2>
    <div class="form-group order-number" id="orderNumberDisplay">注文番号: --</div>

    <!-- 複数商品のカート情報一覧表示 -->
    <div id="productList"></div>

    <div class="price-info" id="priceInfo">
      個数合計: --<br />
      合計: ¥--
    </div>

    <div class="form-row">
      <div style="flex:1">
        <label for="lastNameKanji">姓（漢字）<span style="color:red; font-size:0.8em;">＊必須</span></label>
        <input type="text" id="lastNameKanji" name="lastNameKanji" />
      </div>
      <div style="flex:1">
        <label for="firstNameKanji">名（漢字）<span style="color:red; font-size:0.8em;">＊必須</span></label>
        <input type="text" id="firstNameKanji" name="firstNameKanji" />
      </div>
    </div>

    <div class="form-row">
      <div style="flex:1">
        <label for="lastNameKana">姓（カタカナ）<span style="color:red; font-size:0.8em;">＊必須</span></label>
        <input type="text" id="lastNameKana" name="lastNameKana" />
      </div>
      <div style="flex:1">
        <label for="firstNameKana">名（カタカナ）<span style="color:red; font-size:0.8em;">＊必須</span></label>
        <input type="text" id="firstNameKana" name="firstNameKana" />
      </div>
    </div>

    <div class="form-row">
      <div style="flex:2">
        <label for="postalCode">郵便番号<span style="color:red; font-size:0.8em;">＊必須</span></label>
        <input type="text" id="postalCode" name="postalCode" />
        <div class="small-note">※ハイフンなしで入力してください</div>
      </div>
      <div style="flex:1">
        <button class="small-button" type="button" id="autoFillBtn">自動入力</button>
      </div>
    </div>

    <div class="form-group">
      <label for="prefecture">都道府県：<span style="color:red; font-size:0.8em;">＊必須</span></label>
      <select id="prefecture" name="prefecture" required>
        <option value="">選択してください</option>
        <option value="北海道">北海道</option>
        <option value="青森県">青森県</option>
        <option value="岩手県">岩手県</option>
        <option value="宮城県">宮城県</option>
        <option value="秋田県">秋田県</option>
        <option value="山形県">山形県</option>
        <option value="福島県">福島県</option>
        <option value="茨城県">茨城県</option>
        <option value="栃木県">栃木県</option>
        <option value="群馬県">群馬県</option>
        <option value="埼玉県">埼玉県</option>
        <option value="千葉県">千葉県</option>
        <option value="東京都">東京都</option>
        <option value="神奈川県">神奈川県</option>
        <option value="新潟県">新潟県</option>
        <option value="富山県">富山県</option>
        <option value="石川県">石川県</option>
        <option value="福井県">福井県</option>
        <option value="山梨県">山梨県</option>
        <option value="長野県">長野県</option>
        <option value="岐阜県">岐阜県</option>
        <option value="静岡県">静岡県</option>
        <option value="愛知県">愛知県</option>
        <option value="三重県">三重県</option>
        <option value="滋賀県">滋賀県</option>
        <option value="京都府">京都府</option>
        <option value="大阪府">大阪府</option>
        <option value="兵庫県">兵庫県</option>
        <option value="奈良県">奈良県</option>
        <option value="和歌山県">和歌山県</option>
        <option value="鳥取県">鳥取県</option>
        <option value="島根県">島根県</option>
        <option value="岡山県">岡山県</option>
        <option value="広島県">広島県</option>
        <option value="山口県">山口県</option>
        <option value="徳島県">徳島県</option>
        <option value="香川県">香川県</option>
        <option value="愛媛県">愛媛県</option>
        <option value="高知県">高知県</option>
        <option value="福岡県">福岡県</option>
        <option value="佐賀県">佐賀県</option>
        <option value="長崎県">長崎県</option>
        <option value="熊本県">熊本県</option>
        <option value="大分県">大分県</option>
        <option value="宮崎県">宮崎県</option>
        <option value="鹿児島県">鹿児島県</option>
        <option value="沖縄県">沖縄県</option>
      </select>
    </div>

    <div class="form-group">
      <label for="city">市区町村<span style="color:red; font-size:0.8em;">＊必須</span></label>
      <input type="text" id="city" name="city" />
    </div>

    <div class="form-group">
      <label for="address1">番地<span style="color:red; font-size:0.8em;">＊必須</span></label>
      <input type="text" id="address1" name="address1" />
    </div>

    <div class="form-group">
      <label for="address2">アパート・マンション名、部屋番号</label>
      <input type="text" id="address2" name="address2" />
    </div>

    <div class="form-group">
      <label for="phone">電話番号<span style="color:red; font-size:0.8em;">＊必須</span></label>
      <input type="tel" id="phone" name="phone" placeholder="例: 09012345678" />
    </div>

    <div class="form-group">
      <label for="email">メールアドレス<span style="color:red; font-size:0.8em;">＊必須</span></label>
      <input type="email" id="email" name="email" placeholder="example@example.com" />
    </div>

    <div class="form-group">
      <label>決済方法</label><span style="color:red; font-size:0.8em;">＊必須</span>
      <div class="payment-method">
        <label><input type="radio" name="payment" value="credit" />クレジットカード</label>
        <label><input type="radio" name="payment" value="paypay" />PayPay</label>
        <label><input type="radio" name="payment" value="applepay" />Apple Pay</label>
        <label><input type="radio" name="payment" value="conveni" />コンビニ払い</label>
      </div>
      <div class="payment-fields" id="creditFields">
        <label for="cardNumber">カード番号</label>
        <input type="text" id="cardNumber" name="cardNumber" maxlength="19" placeholder="1234 5678 9012 3456" />
        <div class="form-row">
          <div style="flex:1">
            <label for="expiry">有効期限 (MM/YY)</label>
            <input type="text" id="expiry" name="expiry" maxlength="5" placeholder="12/34" />
          </div>
          <div style="flex:1">
            <label for="securityCode">セキュリティコード</label>
            <input type="text" id="securityCode" name="securityCode" maxlength="4" placeholder="123" />
          </div>
        </div>
        <label for="cardHolder">カード名義人</label>
        <input type="text" id="cardHolder" name="cardHolder" />
      </div>
    </div>

    <div style="text-align: center;">
      <button type="button" id="submitOrderBtn" class="small-button">注文を確定する</button>
    </div>
  </div>

  <!-- 注文確認ダイアログ -->
  <div class="confirm-dialog" id="confirmDialog" role="dialog" aria-modal="true" aria-labelledby="confirmDialogTitle" aria-describedby="confirmDialogDesc">
    <h3 id="confirmDialogTitle">注文内容のご確認</h3>
    <div id="confirmOrderNumber" style="margin-bottom:1rem; font-weight: bold;">注文番号: --</div>
    <div id="confirmProductList" style="max-height: 200px; overflow-y: auto; text-align:left; border: 1px solid #666; padding: 0.5rem; background:#222; border-radius: 5px;"></div>
    <div id="confirmQuantity" style="margin-top:1rem;">数量合計: --</div>
    <div id="confirmTotalPrice" style="margin-bottom: 1rem;">合計金額: ¥--</div>
    <button id="confirmBtn">注文を確定する</button>
    <button id="cancelBtn">キャンセル</button>
  </div>

  <script>
    // サイドバー開閉処理
    const menuButton = document.getElementById('menuButton');
    const sidebar = document.getElementById('sidebar');
    menuButton.addEventListener('click', () => {
      sidebar.classList.toggle('open');
      menuButton.classList.toggle('open');
    });

    // 決済方法選択によるカード入力欄表示制御
    const paymentRadios = document.querySelectorAll('input[name="payment"]');
    const creditFields = document.getElementById('creditFields');
    paymentRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        if (radio.value === 'credit' && radio.checked) {
          creditFields.style.display = 'block';
        } else {
          creditFields.style.display = 'none';
        }
      });
    });

// 郵便番号から住所自動入力
document.getElementById('autoFillBtn').addEventListener('click', () => {
  const postalCode = document.getElementById('postalCode').value.trim();

  if (!postalCode || !/^\d{7}$/.test(postalCode)) {
    alert('郵便番号は7桁の数字で入力してください（ハイフンなし）');
    return;
  }

  const apiUrl = `https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postalCode}`;

  fetch(apiUrl)
    .then(response => response.json())
    .then(data => {
      if (data.status === 200 && data.results) {
        const result = data.results[0];
        const prefectureSelect = document.getElementById('prefecture');
        const prefectureValue = result.address1;

        // 都道府県セレクトボックスで一致する項目を選択
        for (let i = 0; i < prefectureSelect.options.length; i++) {
          if (prefectureSelect.options[i].value === prefectureValue) {
            prefectureSelect.selectedIndex = i;
            break;
          }
        }

        document.getElementById('city').value = (result.address2 || '') + (result.address3 || '');
        document.getElementById('address1').value = '';
      } else {
        alert('住所が見つかりませんでした。郵便番号を確認してください。');
      }
    })
    .catch(() => {
      alert('住所の取得に失敗しました。ネットワーク接続を確認してください。');
    });
});

    // ローカルストレージのカート情報読み込み＋表示
    window.addEventListener('DOMContentLoaded', () => {
      const cartItems = JSON.parse(localStorage.getItem('cart')) || [];

      if (cartItems.length === 0) {
        alert('カートに商品がありません。ギャラリーに戻ります。');
        window.location.href = '/works/'; // ギャラリーへ戻す
        return;
      }

      // 注文番号ランダム生成（8桁の数字）
      const orderNumber = '#' + Math.floor(Math.random() * 90000000 + 10000000);
      document.getElementById('orderNumberDisplay').textContent = `注文番号: ${orderNumber}`;

      // 商品一覧表示用
      const productListContainer = document.getElementById('productList');
      productListContainer.innerHTML = '';

      let totalQuantity = 0;
      let totalPrice = 0;

      cartItems.forEach(item => {
        totalQuantity += item.quantity;
        totalPrice += item.price * item.quantity;

        const itemDiv = document.createElement('div');
        itemDiv.className = 'cart-item';
        itemDiv.innerHTML = `
          <img src="${item.image}" alt="${item.title}" />
          <div>
            <p>${item.title}</p>
            <p>単価: ¥${item.price.toLocaleString()}</p>
            <p>数量: ${item.quantity}</p>
            <p>小計: ¥${(item.price * item.quantity).toLocaleString()}</p>
          </div>
        `;
        productListContainer.appendChild(itemDiv);
      });

      document.getElementById('priceInfo').innerHTML = `
        個数合計: ${totalQuantity}<br />
        合計: ¥${totalPrice.toLocaleString()}
      `;

      // 確認ダイアログの注文番号表示
      document.getElementById('confirmOrderNumber').textContent = `注文番号: ${orderNumber}`;

      // 確認ダイアログの商品リスト表示
      const confirmProductList = document.getElementById('confirmProductList');
      confirmProductList.innerHTML = '';
      cartItems.forEach(item => {
        const div = document.createElement('div');
        div.style.marginBottom = '0.5rem';
        div.textContent = `${item.title} × ${item.quantity} — ¥${(item.price * item.quantity).toLocaleString()}`;
        confirmProductList.appendChild(div);
      });

      document.getElementById('confirmQuantity').textContent = `数量合計: ${totalQuantity}`;
      document.getElementById('confirmTotalPrice').textContent = `合計金額: ¥${totalPrice.toLocaleString()}`;
    });

    // フォームの必須チェックと確認ダイアログ表示
    const submitOrderBtn = document.getElementById('submitOrderBtn');
    const confirmDialog = document.getElementById('confirmDialog');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    function validateForm() {
      const requiredFields = [
        'lastNameKanji', 'firstNameKanji',
        'lastNameKana', 'firstNameKana',
        'postalCode', 'prefecture',
        'city', 'address1',
        'phone', 'email'
      ];

      for(const id of requiredFields) {
        const el = document.getElementById(id);
        if(!el || el.value.trim() === '') {
          alert('必須項目をすべて入力してください。');
          el?.focus();
          return false;
        }
      }

      // メールアドレス簡易チェック
      const email = document.getElementById('email').value.trim();
      if(!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        alert('正しいメールアドレスを入力してください。');
        document.getElementById('email').focus();
        return false;
      }

      // 郵便番号数字7桁チェック
      const postal = document.getElementById('postalCode').value.trim();
      if(!/^\d{7}$/.test(postal)) {
        alert('郵便番号は7桁の数字で入力してください（ハイフンなし）。');
        document.getElementById('postalCode').focus();
        return false;
      }

      // 決済方法チェック
      const payment = document.querySelector('input[name="payment"]:checked');
      if(!payment) {
        alert('決済方法を選択してください。');
        return false;
      }

      // クレジットカードならカード情報も必須チェック
      if(payment.value === 'credit') {
        const cardFields = ['cardNumber', 'expiry', 'securityCode', 'cardHolder'];
        for(const id of cardFields) {
          const el = document.getElementById(id);
          if(!el || el.value.trim() === '') {
            alert('クレジットカード情報をすべて入力してください。');
            el?.focus();
            return false;
          }
        }
      }

      return true;
    }

    submitOrderBtn.addEventListener('click', () => {
      if(!validateForm()) return;

      // 確認ダイアログ表示
      confirmDialog.style.display = 'block';
    });

    cancelBtn.addEventListener('click', () => {
      confirmDialog.style.display = 'none';
    });

    confirmBtn.addEventListener('click', () => {
      // 送信処理（ここではAPIのPOST送信を例示）
      const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
      if(cartItems.length === 0) {
        alert('カートに商品がありません。');
        confirmDialog.style.display = 'none';
        return;
      }

      const orderNumber = document.getElementById('orderNumberDisplay').textContent.replace('注文番号: ', '');

      const orderData = {
        orderNumber: orderNumber,
        items: cartItems,
        totalQuantity: cartItems.reduce((sum, item) => sum + item.quantity, 0),
        totalPrice: cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0),

        nameKanji: {
          last: document.getElementById('lastNameKanji').value.trim(),
          first: document.getElementById('firstNameKanji').value.trim(),
        },
        nameKana: {
          last: document.getElementById('lastNameKana').value.trim(),
          first: document.getElementById('firstNameKana').value.trim(),
        },
        postalCode: document.getElementById('postalCode').value.trim(),
        prefecture: document.getElementById('prefecture').value,
        city: document.getElementById('city').value.trim(),
        address1: document.getElementById('address1').value.trim(),
        address2: document.getElementById('address2').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        email: document.getElementById('email').value.trim(),
        paymentMethod: document.querySelector('input[name="payment"]:checked')?.value || '',
      };

      if(orderData.paymentMethod === 'credit') {
        orderData.creditCardInfo = {
          cardNumber: document.getElementById('cardNumber').value.trim(),
          expiry: document.getElementById('expiry').value.trim(),
          securityCode: document.getElementById('securityCode').value.trim(),
          cardHolder: document.getElementById('cardHolder').value.trim(),
        };
      }

      // ダミーのAPI送信例
      fetch('https://example.com/api/order', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(orderData),
      })
      .then(response => {
        if (!response.ok) throw new Error('ネットワークエラー');
        return response.json();
      })
      .then(data => {
        alert('注文が完了しました！');
        // カートをクリアしてリダイレクトなど
        localStorage.removeItem('cart');
        window.location.href = '/thanks'; // 完了ページに遷移
      })
      .catch(err => {
        alert('注文処理に失敗しました。再度お試しください。');
        console.error(err);
      });
    });
  </script>
</body>
</html>
